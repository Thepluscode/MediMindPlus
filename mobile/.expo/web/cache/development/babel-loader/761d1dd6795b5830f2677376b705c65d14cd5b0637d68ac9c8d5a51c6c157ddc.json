{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport axios, { AxiosRequestConfig } from 'axios';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { store } from \"../store/store\";\nimport { setTokens } from \"../store/slices/authSlice\";\nexport var ML_API_BASE_URL = __DEV__ ? 'http://localhost:8000' : 'https://ml.medimind.app';\nexport var API_BASE_URL = __DEV__ ? 'http://localhost:3000/api' : 'https://api.medimind.app/api';\nvar apiService = axios.create({\n  baseURL: API_BASE_URL,\n  timeout: 30000,\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\nconsole.log('[apiService] Initialized with base URL:', API_BASE_URL);\nexport var mlApiService = axios.create({\n  baseURL: ML_API_BASE_URL,\n  timeout: 60000,\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\napiService.interceptors.request.use(function () {\n  var _ref = _asyncToGenerator(function* (config) {\n    var _config$method, _config$url, _config$url2;\n    console.log('[apiService] Outgoing request:', (_config$method = config.method) == null ? void 0 : _config$method.toUpperCase(), config.url);\n    if ((_config$url = config.url) != null && _config$url.includes('/auth/register') || (_config$url2 = config.url) != null && _config$url2.includes('/auth/login')) {\n      console.log('[apiService] Skipping auth token for public endpoint');\n      return config;\n    }\n    try {\n      var token;\n      if (typeof globalThis.window !== 'undefined') {\n        token = globalThis.localStorage.getItem('authToken');\n      } else {\n        token = yield Promise.race([AsyncStorage.getItem('authToken'), new Promise(function (_, reject) {\n          return setTimeout(function () {\n            return reject(new Error('AsyncStorage timeout'));\n          }, 1000);\n        })]);\n      }\n      if (token && config.headers) {\n        config.headers.Authorization = `Bearer ${token}`;\n      }\n    } catch (error) {\n      console.warn('[apiService] Failed to get auth token:', error);\n    }\n    return config;\n  });\n  return function (_x) {\n    return _ref.apply(this, arguments);\n  };\n}(), function (error) {\n  console.error('[apiService] Request error:', error);\n  return Promise.reject(error);\n});\napiService.interceptors.response.use(function (response) {\n  console.log('[apiService] Response received:', response.status, response.config.url);\n  return response;\n}, function () {\n  var _ref2 = _asyncToGenerator(function* (error) {\n    var _error$response, _error$config, _error$response2;\n    console.error('[apiService] Response error:', {\n      message: error.message,\n      code: error.code,\n      status: (_error$response = error.response) == null ? void 0 : _error$response.status,\n      url: (_error$config = error.config) == null ? void 0 : _error$config.url\n    });\n    var originalRequest = error.config;\n    if (((_error$response2 = error.response) == null ? void 0 : _error$response2.status) === 401 && originalRequest && !originalRequest._retry) {\n      originalRequest._retry = true;\n      try {\n        var refreshToken;\n        if (typeof globalThis.window !== 'undefined') {\n          refreshToken = globalThis.localStorage.getItem('refreshToken');\n        } else {\n          refreshToken = yield AsyncStorage.getItem('refreshToken');\n        }\n        if (refreshToken) {\n          var response = yield axios.post(`${API_BASE_URL}/auth/refresh`, {\n            refreshToken: refreshToken\n          });\n          var _response$data = response.data,\n            token = _response$data.token,\n            newRefreshToken = _response$data.refreshToken;\n          if (token && newRefreshToken) {\n            if (typeof globalThis.window !== 'undefined') {\n              globalThis.localStorage.setItem('authToken', token);\n              globalThis.localStorage.setItem('refreshToken', newRefreshToken);\n            } else {\n              yield AsyncStorage.setItem('authToken', token);\n              yield AsyncStorage.setItem('refreshToken', newRefreshToken);\n            }\n            store.dispatch(setTokens({\n              token: token,\n              refreshToken: newRefreshToken\n            }));\n            if (originalRequest.headers) {\n              originalRequest.headers.Authorization = `Bearer ${token}`;\n            }\n            return apiService(originalRequest);\n          }\n        }\n      } catch (refreshError) {\n        if (typeof globalThis.window !== 'undefined') {\n          globalThis.localStorage.removeItem('authToken');\n          globalThis.localStorage.removeItem('refreshToken');\n          globalThis.localStorage.removeItem('user');\n        } else {\n          yield AsyncStorage.multiRemove(['authToken', 'refreshToken', 'user']);\n        }\n        console.log('Session expired, please log in again');\n      }\n    }\n    return Promise.reject(error);\n  });\n  return function (_x2) {\n    return _ref2.apply(this, arguments);\n  };\n}());\nvar typedApiService = {\n  get: function get(url, config) {\n    return apiService.get(url, config);\n  },\n  post: function post(url, data, config) {\n    return apiService.post(url, data, config);\n  },\n  put: function put(url, data, config) {\n    return apiService.put(url, data, config);\n  },\n  delete: function _delete(url, config) {\n    return apiService.delete(url, config);\n  },\n  patch: function patch(url, data, config) {\n    return apiService.patch(url, data, config);\n  }\n};\nexport default typedApiService;","map":{"version":3,"names":["axios","AxiosRequestConfig","AsyncStorage","store","setTokens","ML_API_BASE_URL","__DEV__","API_BASE_URL","apiService","create","baseURL","timeout","headers","console","log","mlApiService","interceptors","request","use","_ref","_asyncToGenerator","config","_config$method","_config$url","_config$url2","method","toUpperCase","url","includes","token","globalThis","window","localStorage","getItem","Promise","race","_","reject","setTimeout","Error","Authorization","error","warn","_x","apply","arguments","response","status","_ref2","_error$response","_error$config","_error$response2","message","code","originalRequest","_retry","refreshToken","post","_response$data","data","newRefreshToken","setItem","dispatch","refreshError","removeItem","multiRemove","_x2","typedApiService","get","put","delete","patch"],"sources":["/Users/theophilusogieva/Desktop/MediMindPlus/MediMindPlus/frontend/src/services/apiService.ts"],"sourcesContent":["import axios, { AxiosError, AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { store } from '../store/store';\nimport { setTokens } from '../store/slices/authSlice';\nimport { AuthResponse } from '../types/models/user';\n\n// ML Pipeline API (direct connection for health predictions)\nexport const ML_API_BASE_URL = __DEV__\n  ? 'http://localhost:8000'\n  : 'https://ml.medimind.app';\n\n// Backend API (for user management, data storage)\nexport const API_BASE_URL = __DEV__\n  ? 'http://localhost:3000/api'\n  : 'https://api.medimind.app/api';\n\n// Extend AxiosRequestConfig to include _retry flag\ndeclare module 'axios' {\n  export interface AxiosRequestConfig {\n    _retry?: boolean;\n  }\n}\n\n// Create axios instance for backend API\nconst apiService: AxiosInstance = axios.create({\n  baseURL: API_BASE_URL,\n  timeout: 30000, // Increased to 30 seconds\n  headers: {\n    'Content-Type': 'application/json',\n  },\n});\n\nconsole.log('[apiService] Initialized with base URL:', API_BASE_URL);\n\n// Create axios instance for ML Pipeline API\nexport const mlApiService: AxiosInstance = axios.create({\n  baseURL: ML_API_BASE_URL,\n  timeout: 60000, // Longer timeout for ML operations\n  headers: {\n    'Content-Type': 'application/json',\n  },\n});\n\n// Request interceptor to add auth token\napiService.interceptors.request.use(\n  async (config: any) => {\n    console.log('[apiService] Outgoing request:', config.method?.toUpperCase(), config.url);\n    // Skip token for registration and login endpoints\n    if (config.url?.includes('/auth/register') || config.url?.includes('/auth/login')) {\n      console.log('[apiService] Skipping auth token for public endpoint');\n      return config;\n    }\n\n    try {\n      let token: string | null;\n\n      // Use localStorage on web to avoid blocking\n      if (typeof (globalThis as any).window !== 'undefined') {\n        token = (globalThis as any).localStorage.getItem('authToken');\n      } else {\n        // Use AsyncStorage on mobile with timeout protection\n        token = await Promise.race([\n          AsyncStorage.getItem('authToken'),\n          new Promise<string | null>((_, reject) => setTimeout(() => reject(new Error('AsyncStorage timeout')), 1000))\n        ]);\n      }\n\n      if (token && config.headers) {\n        config.headers.Authorization = `Bearer ${token}`;\n      }\n    } catch (error) {\n      console.warn('[apiService] Failed to get auth token:', error);\n    }\n    return config;\n  },\n  (error: AxiosError) => {\n    console.error('[apiService] Request error:', error);\n    return Promise.reject(error);\n  }\n);\n\n// Response interceptor to handle token refresh\napiService.interceptors.response.use(\n  (response: AxiosResponse) => {\n    console.log('[apiService] Response received:', response.status, response.config.url);\n    return response;\n  },\n  async (error: AxiosError) => {\n    console.error('[apiService] Response error:', {\n      message: error.message,\n      code: error.code,\n      status: error.response?.status,\n      url: error.config?.url\n    });\n    const originalRequest = error.config;\n\n    if (error.response?.status === 401 && originalRequest && !originalRequest._retry) {\n      originalRequest._retry = true;\n\n      try {\n        let refreshToken: string | null;\n\n        // Use localStorage on web to avoid blocking\n        if (typeof (globalThis as any).window !== 'undefined') {\n          refreshToken = (globalThis as any).localStorage.getItem('refreshToken');\n        } else {\n          // Use AsyncStorage on mobile\n          refreshToken = await AsyncStorage.getItem('refreshToken');\n        }\n\n        if (refreshToken) {\n          const response = await axios.post<AuthResponse>(\n            `${API_BASE_URL}/auth/refresh`,\n            { refreshToken }\n          );\n\n          const { token, refreshToken: newRefreshToken } = response.data;\n\n          if (token && newRefreshToken) {\n            // Update tokens in storage and store\n            if (typeof (globalThis as any).window !== 'undefined') {\n              // Use localStorage on web\n              (globalThis as any).localStorage.setItem('authToken', token);\n              (globalThis as any).localStorage.setItem('refreshToken', newRefreshToken);\n            } else {\n              // Use AsyncStorage on mobile\n              await AsyncStorage.setItem('authToken', token);\n              await AsyncStorage.setItem('refreshToken', newRefreshToken);\n            }\n\n            store.dispatch(setTokens({ token, refreshToken: newRefreshToken }));\n\n            // Retry original request\n            if (originalRequest.headers) {\n              originalRequest.headers.Authorization = `Bearer ${token}`;\n            }\n            return apiService(originalRequest);\n          }\n        }\n      } catch (refreshError) {\n        // Refresh failed, clear tokens and redirect to login\n        if (typeof (globalThis as any).window !== 'undefined') {\n          // Use localStorage on web\n          (globalThis as any).localStorage.removeItem('authToken');\n          (globalThis as any).localStorage.removeItem('refreshToken');\n          (globalThis as any).localStorage.removeItem('user');\n        } else {\n          // Use AsyncStorage on mobile\n          await AsyncStorage.multiRemove(['authToken', 'refreshToken', 'user']);\n        }\n        console.log('Session expired, please log in again');\n      }\n    }\n\n    return Promise.reject(error);\n  }\n);\n\n// Add type-safe request methods\nconst typedApiService = {\n  get: <T = any>(url: string, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> => \n    apiService.get<T>(url, config),\n  \n  post: <T = any>(\n    url: string, \n    data?: any, \n    config?: AxiosRequestConfig\n  ): Promise<AxiosResponse<T>> => \n    apiService.post<T>(url, data, config),\n  \n  put: <T = any>(\n    url: string, \n    data?: any, \n    config?: AxiosRequestConfig\n  ): Promise<AxiosResponse<T>> => \n    apiService.put<T>(url, data, config),\n  \n  delete: <T = any>(url: string, config?: AxiosRequestConfig): Promise<AxiosResponse<T>> => \n    apiService.delete<T>(url, config),\n  \n  patch: <T = any>(\n    url: string, \n    data?: any, \n    config?: AxiosRequestConfig\n  ): Promise<AxiosResponse<T>> => \n    apiService.patch<T>(url, data, config),\n};\n\nexport default typedApiService;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}